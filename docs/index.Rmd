---
title: "Gender Pay Gap"
author: "Ross McCullough - Group 9"
date: "09/10/2022"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Imports

```{r, message=FALSE}
library(tidyverse)
library(lubridate)
library(rmarkdown)
library(knitr)

#Set printed table options to a number that is not computationally limiting 
options(max.print = 100)
```

## Load Data

### Load Yearly Pay Gap Data

Gender pay gap data is provided for a number of years. All data is stored to the `./data` folder. `glob` is used to find the files and they are concatenated into to a dataframe.

```{r, message=FALSE}
#List file is data dir matching pattern
gender_paygap_year_files <- 
  Sys.glob("../data/UK Gender Pay Gap Data -*.csv")

#empty dataframe to append to
all_year_df <- tibble()

#for loop to run over file, read and concat
for (csv in gender_paygap_year_files){
  year_df <- read_csv(csv)
  all_year_df <- rbind(all_year_df, year_df)
}
```

It will be useful to be able to access the year later for analysis. This is pulled from the survey due date column, though there may be more reliable options, such as from the file path.

```{r}
# Get the year from the due date
all_year_df <-
  all_year_df %>%
  mutate(year = year(DueDate))
```

A summary of the data is shown below

```{r}
paged_table(all_year_df)
```


### Load University Data

Ingest the universities data that designates whether the university was established pre 1992

```{r}
universities_df <-
  read_csv("../data/universities.csv")

paged_table(universities_df)
```

## Join Data

The data is joined on the `EmployerId` column. This is prefferable to the name column which is suspectible to special characters, case, etc variation

```{r}
combined_df <- 
  inner_join(universities_df,
             all_year_df,
             by="EmployerId")
```

## Analyse

### Contingency Tables

A contigency table of submissions by year (row) with `pre92` status (column). 

```{r}
contigency_df<-
  combined_df %>%
  group_by(year)%>%
  count(pre92) %>%
  pivot_wider(values_from = n, names_from = pre92)

kable(contigency_df)
```

### Universties Submissions by Year

Total submissions by year. A possible drop of is seen around 2020.

```{r}
employee_ids <- universities_df$EmployerId

year_counts <-
  all_year_df %>%
  filter(EmployerId %in% employee_ids)%>%
  group_by(year)%>%
  count() 

kable(year_counts)
```

### Summary Statistic

Total submissions by year. A possible drop of is seen around 2020.

```{r}
summary_df <- 
  combined_df %>%
  group_by(year)%>%
  summarise(min(DiffMedianHourlyPercent), mean(DiffMedianHourlyPercent), max(DiffMedianHourlyPercent))

kable(summary_df)
```
### Visulations - Boxplot Median Payt Difference by Year

Total submissions by year. A possible drop of is seen around 2020.

```{r}
ggplot(data = combined_df, aes(x=factor(year), y=DiffMedianHourlyPercent, fill=pre92))+
  geom_boxplot()
```


### Visulations - Best and worst 

```{r}
full_sub_df <-
  combined_df %>%
  drop_na(DiffMedianHourlyPercent) %>%
  group_by(EmployerName.x)%>%
  count() %>%
  filter(n==5)
  


plot_df <-
  combined_df %>%
  select(c(EmployerName.x, pre92, year, DiffMedianHourlyPercent, EmployerSize)) %>%
  mutate(University = EmployerName.x)%>%
  filter(University %in% full_sub_df$EmployerName.x) %>%
  filter(EmployerSize == '1000 to 4999')

mean_median_hourly_df <-
  plot_df %>%
  group_by(year) %>%
  summarize(Mean = mean(DiffMedianHourlyPercent))

ggplot(data = mean_median_hourly_df, aes(x=year, y=Mean))+
  geom_line(data = plot_df, 
            aes(y = DiffMedianHourlyPercent, group = University), 
            color = "grey", 
            size = 1, 
            alpha = 0.5) +
  geom_line()+
  geom_point()+
  theme(legend.position = "none")

```

```{r}
days_late <- 
  combined_df %>%
  filter(year == 2022)%>%
  mutate(days_late = difftime(DueDate, DateSubmitted, units="days"))

ggplot(data = days_late, aes(x=pre92, y = days_late))+
  geom_point()
```


```{r}
days_late <- 
  combined_df %>%
  mutate(days_late = difftime(DueDate, DateSubmitted, units="days"))

ggplot(data = days_late, aes(x=factor(pre92), y = days_late))+
  geom_boxplot()



```


```{r}
postcode_df <- read.csv("https://raw.githubusercontent.com/radiac/UK-Postcodes/master/postcodes.csv")

postcode_df

plot_me <- 
  combined_df%>%
  rowwise()%>%
  mutate(split_postcode =  scan(text=PostCode, what = " ")[1])%>%
  inner_join(x=., y=postcode_df, by= c('split_postcode' = 'postcode'))%>%
  filter(EmployerSize == '1000 to 4999'|EmployerSize == '5000 to 19,999')
  

```


```{r}

ggplot(data=plot_me, aes(x=latitude, y = DiffMedianHourlyPercent))+
  geom_point()+
  geom_smooth(method = 'lm')+
  facet_wrap(~year)
  
```

